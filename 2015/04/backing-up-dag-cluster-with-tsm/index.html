<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<title>Backing up DAG cluster with TSM</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-19900770-2"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-19900770-2")</script>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1">
<link rel=alternate type=application/rss+xml href=https://trukhanov.com/index.xml title="Perpetuum informatio - Never ending IT story">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Backing up DAG cluster with TSM">
<meta name=twitter:description content="There is a problem with DAG cluster backup in TSM. When you create script with /PREFERDAGPASSIVE key, your script return error 464 – nothing to backup. So I’ve created script to analyze Exchange’s databases if there is healthy passive copy of database to backup, so you run backup for the only healthy copy of database and for passive healthy copies of database. If there is nothing to backup than script returns 0.">
<link rel=stylesheet href=https://trukhanov.com/fontawesome/css/all.min.css>
<link crossorigin=anonymous href=/css/styles.min.css integrity rel="preload stylesheet" as=style>
<link rel=stylesheet href=https://trukhanov.com/css/custom.css>
<link id=dark-mode-theme crossorigin=anonymous href=/css/dark.min.css integrity rel="preload stylesheet" as=style>
<script>var darkTheme=document.getElementById("dark-mode-theme"),storedTheme=localStorage.getItem("dark-mode-storage");storedTheme==="dark"?darkTheme.disabled=!1:storedTheme==="light"&&(darkTheme.disabled=!0)</script>
<script defer crossorigin=anonymous src=/js/theme.js integrity></script>
<script defer crossorigin=anonymous src=/js/instantpage.min.js integrity></script><meta name=generator content="Hugo 0.93.0">
</head><body>
<header>
<nav class=navbar>
<div class=nav>
<ul class=nav-links>
</ul></div></nav><div class=intro-header>
<div class=container>
<div class=post-heading>
<h1>
Backing up DAG cluster with TSM
</h1><span class=meta-post>
<em class="fa fa-calendar-alt"></em>&nbsp;Apr 29, 2015
&nbsp;&nbsp;&nbsp;<em class="fa fa-folder-open"></em>&nbsp;
<a href=https://trukhanov.com/categories/TSM/>TSM</a>&nbsp;
</span>
</div></div></div></header><div class=container role=main>
<article class=article class=blog-post>
<p>There is a problem with DAG cluster backup in TSM. When you create script with /PREFERDAGPASSIVE key, your script return error 464 – nothing to backup. So I’ve created script to analyze Exchange’s databases if there is healthy passive copy of database to backup, so you run backup for the only healthy copy of database and for passive healthy copies of database. If there is nothing to backup than script returns 0.</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#19177c>$exc_dir</span>=<span style=color:#ba2121>&#34;C:\Program Files\Tivoli\TSM\TDPExchange&#34;</span>
</span></span><span style=display:flex><span><span style=color:green>cd </span><span style=color:#19177c>$exc_dir</span>  
</span></span><span style=display:flex><span><span style=color:green>Get-Date</span> -UFormat <span style=color:#ba2121>&#34;%Y-%m-%d %T&#34;</span> | <span style=color:green>Out-File</span> -Encoding utf8 -FilePath excfull.log -Append  
</span></span><span style=display:flex><span><span style=color:green>add-pssnapin</span> Microsoft.Exchange.Management.PowerShell.E2010  
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>foreach</span> (<span style=color:#19177c>$maildatabase</span> <span style=color:green;font-weight:700>in</span> <span style=color:green>Get-MailboxDatabase</span> -Server <span style=color:#19177c>$env:COMPUTERNAME</span>)  
</span></span><span style=display:flex><span>{  
</span></span><span style=display:flex><span>    <span style=color:#19177c>$copies</span>=0;  
</span></span><span style=display:flex><span>    <span style=color:#19177c>$needtobackup</span>=<span style=color:#19177c>$False</span>;  
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>foreach</span>(<span style=color:#19177c>$dbcopy</span> <span style=color:green;font-weight:700>in</span> <span style=color:green>Get-MailboxDatabaseCopyStatus</span> <span style=color:#19177c>$maildatabase</span>)  
</span></span><span style=display:flex><span>    {  
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>if</span>((<span style=color:#19177c>$dbcopy</span>.Status <span style=color:#666>-eq</span> <span style=color:#ba2121>&#34;Mounted&#34;</span>) <span style=color:#666>-or</span> (<span style=color:#19177c>$dbcopy</span>.Status <span style=color:#666>-eq</span> <span style=color:#ba2121>&#34;Healthy&#34;</span>))  
</span></span><span style=display:flex><span>        {  
</span></span><span style=display:flex><span>            <span style=color:#19177c>$copies</span>+=1  
</span></span><span style=display:flex><span>        }  
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>if</span>((!<span style=color:#19177c>$dbcopy</span>.ActiveCopy) <span style=color:#666>-and</span> (<span style=color:#19177c>$dbcopy</span>.MailboxServer <span style=color:#666>-eq</span> <span style=color:#19177c>$env:COMPUTERNAME</span>))  
</span></span><span style=display:flex><span>        {  
</span></span><span style=display:flex><span>            <span style=color:#19177c>$needtobackup</span>=<span style=color:#19177c>$True</span>  
</span></span><span style=display:flex><span>        }  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>if</span>(<span style=color:#19177c>$copies</span> <span style=color:#666>-lt</span> 2)  
</span></span><span style=display:flex><span>    {  
</span></span><span style=display:flex><span>        <span style=color:#19177c>$needtobackup</span>=<span style=color:#19177c>$True</span>  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>if</span>(<span style=color:#19177c>$needtobackup</span>)  
</span></span><span style=display:flex><span>{  
</span></span><span style=display:flex><span>    .\tdpexcc.exe backup * full /PREFERDAGPASSIVE /tsmoptfile=dsm.opt /CONFIGfile=tdpexc.cfg /logfile=excsch.log | <span style=color:green>Out-File</span> -Encoding utf8 -FilePath excfull.log -Append  
</span></span><span style=display:flex><span>    <span style=color:#19177c>$backupresult</span> = <span style=color:#19177c>$LASTEXITCODE</span>  
</span></span><span style=display:flex><span>    <span style=color:#ba2121>&#34;Return code was $backupresult&#34;</span> | <span style=color:green>Out-File</span> -Encoding utf8 -FilePath excfull.log -Append  
</span></span><span style=display:flex><span>}<span style=color:green;font-weight:700>else</span>{  
</span></span><span style=display:flex><span>    <span style=color:#ba2121>&#34;Nothing to backup&#34;</span> | <span style=color:green>Out-File</span> -Encoding utf8 -FilePath excfull.log -Append  
</span></span><span style=display:flex><span>    <span style=color:#19177c>$backupresult</span>=0  
</span></span><span style=display:flex><span>    <span style=color:#ba2121>&#34;Return code was $backupresult&#34;</span> | <span style=color:green>Out-File</span> -Encoding utf8 -FilePath excfull.log -Append  
</span></span><span style=display:flex><span>}  
</span></span><span style=display:flex><span>exit <span style=color:#19177c>$backupresult</span>
</span></span></code></pre></td></tr></table></div></div><div class=blog-tags>
<a href=https://trukhanov.com/tags/TSM/>TSM</a>&nbsp;
</div></article><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname=="localhost")return;var e=document.createElement("script"),t;e.type="text/javascript",e.async=!0,t="trukhanov-com",e.src="//"+t+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script>
<noscript>Please enable JavaScript to view the
<a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</div><footer>
<div class=social-icons>
</div><div class=container>
<p class="credits copyright">
<a href=https://trukhanov.com/about></a>
&nbsp;&copy;
2017
&nbsp;/&nbsp;
<a href=https://trukhanov.com/>Perpetuum informatio - Never ending IT story</a>
&nbsp;&ndash;&nbsp;
<em class="fas fa-moon" id=dark-mode-toggle></em>
</p><p class="credits theme-by">
Powered By <a href=https://gohugo.io>Hugo</a>&nbsp;
Theme
<a href=https://github.com/matsuyoshi30/harbor>Harbor</a>
</p></div></footer></body></html>